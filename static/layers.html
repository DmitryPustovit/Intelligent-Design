<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
<style media="screen">
  body{
    width: 260px;
    margin: 0;
    padding: 0;
  }

  .layer{
    position: relative;
    padding: 28px;
  }

  .layer:hover{
    background: #BBDEFB;
  }

  .canvasHolder{
    width: 70px;
    height: 50px;
    display: inline-block;
    position: absolute;
    top: 11px;
    left: 4px;
    border: 1px solid black;
  }

  .selected{
    background: #64B5F6 !important;
  }

  span{
    margin-left: 70px;
  }

  input{
    float: right;
  }

  .content{
    height: 300px;
    overflow-y: scroll;
  }

  .rotate180 {
  -webkit-transform: rotate(180deg);     /* Chrome and other webkit browsers */
  -moz-transform: rotate(180deg);        /* FF */
  -o-transform: rotate(180deg);          /* Opera */
  -ms-transform: rotate(180deg);         /* IE9 */
  transform: rotate(180deg);             /* W3C compliant browsers */

  /* IE8 and below */
  filter: progid:DXImageTransform.Microsoft.Matrix(M11=-1, M12=0, M21=0, M22=-1, DX=0, DY=0, SizingMethod='auto expand');
}
</style>

<body>
  <div id="layers" class="content">
  <div class="layer selected" id="1">
    <div class="canvasHolder"> </div>
    <span> layer 1 </span>
    <input class="check" type="checkbox" checked>
  </div>

</div>
<i class="material-icons" id="add">add</i>
<i class="material-icons" id="remove">remove</i>
<i class="material-icons rotate180" id="merge">merge_type</i>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script>
var layers = [1];
var selected = 1;
var counter = 1;
var div = document.getElementById('layers');
var global = this; // WHY WHY WHY

$( "#add" ).click(function() {
  div.innerHTML =
  '<div class="layer" id="' + ++counter + '">' +
    '<div class="canvasHolder"> </div>' +
    '<span> layer ' + counter   +  '</span>' +
    '<input class="check" type="checkbox" checked>' +
  '</div>' + div.innerHTML;

  layers.push(counter);
  console.log(layers);

  parent.createLayer(counter);
});


$( "#remove" ).click(function() {
  $('.selected').remove();
  var cur = global.selected;
  var indexOfCur = layers.indexOf(parseInt(cur));
  layers.splice(indexOfCur, 1);
  parent.removeLayer(cur);
});

$( "#merge" ).click(function() {
  if(selected != layers[0] && layers.length > 1)
  {
    var top = global.selected;
    var indexOfTop = layers.indexOf(parseInt(top));
    var indexOfBottom = layers.indexOf(parseInt(top)) - 1;
    var bottom = layers[indexOfBottom]; //IDs
    parent.mergeLayer(top, bottom);
    $('.selected').remove();
    layers.splice(indexOfTop, 1);
    console.log(layers);
  }
});

function flatten(){
  console.log(layers);
  layers = [layers[0]];
  console.log(layers);
  div.innerHTML =
  '<div class="layer" id="' + layers[0] + '">' +
    '<div class="canvasHolder"> </div>' +
    '<span> layer ' + layers[0]   +  '</span>' +
    '<input type="checkbox" checked>' +
  '</div>'
}


$(document).ready(function(){
  $(document).delegate( ".layer", "click", function() {
    $(".layer").removeClass('selected');
    $(this).addClass('selected');
    selected = $(this).attr('id');
    console.log(selected);
    parent.selectLayer($(this).attr('id'));
});

$(document).delegate( ".check", "change", function() {
  var hide;
  console.log("layer: hide");
  if($(this).is(":checked")) {
    hide = 0;
  }
  else {
    hide = 1;
  }

  parent.hideLayer($(this).parent().attr('id'), hide);
});


});

window.addEventListener('message', receiver, false);

function receiver(e) {
   if (e.origin == '*') {
     console.log("baka");
     return;
   } else {
		 var data = e.data.split(',');

		if(data[0] == 'flattenLayers')
			flatten();

console.log("layer falaten command ");
		 console.log(data);
   }
}

</script>
